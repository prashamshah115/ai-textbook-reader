# Design Decisions & Answers to Key Questions
## AI Textbook Reader - Final Locked Decisions

---

## üéØ EXECUTIVE SUMMARY

This document provides FINAL answers to all design questions and locks in every decision. No ambiguity remains.

---

## ‚ùì QUESTIONS & ANSWERS

### 1. Chapter Detection - Manual Editing?

**DECISION: YES - Allow manual chapter editing**

**Implementation**:
```typescript
// User can:
1. View auto-detected chapters
2. Edit chapter boundaries (start/end pages)
3. Add new chapters manually
4. Merge/split chapters
5. Delete incorrect chapters

// UI: "Manage Chapters" modal
interface ChapterManager {
  chapters: Chapter[]
  onEdit: (id: string, updates: Partial<Chapter>) => void
  onAdd: () => void
  onDelete: (id: string) => void
}
```

**Why**: Textbooks have varied structures. Auto-detection won't be perfect. Give users control.

**UX**: Accessible via textbook settings, not prominent (most users won't need it).

---

### 2. Note Organization - Hierarchical?

**DECISION: FLAT with filtering, not hierarchical**

**Structure**:
```
Notes
‚îú‚îÄ‚îÄ Filter by Textbook (automatic)
‚îú‚îÄ‚îÄ Filter by Chapter (dropdown)
‚îî‚îÄ‚îÄ Sort by: Date Created | Last Updated | Title

Each note shows:
- Title
- Preview (first 100 chars)
- Chapter tag
- Page range
- Last updated timestamp
```

**Why**: 
- Simpler to implement
- Easier to search across all notes
- Most students take notes linearly
- Can always add hierarchy later if needed

**Rejected Alternative**: Tree structure (Textbook > Chapter > Note) - too complex for v1

---

### 3. Export Options - Formats?

**DECISION: 3 formats - Markdown, PDF, and Plain Text**

**Implementation**:
```typescript
export interface ExportOptions {
  format: 'markdown' | 'pdf' | 'txt'
  scope: 'single-note' | 'all-notes' | 'chapter-notes'
  includeMetadata: boolean // textbook title, chapter, dates
  includeSummaries: boolean // append AI summaries if exporting chapter
}

// Export menu:
"Export" button ‚Üí Dropdown:
  - Export this note (Markdown)
  - Export this note (PDF)
  - Export all notes for this textbook (PDF)
  - Export all notes for this chapter (Markdown)
```

**Markdown Format**:
```markdown
# Note Title

**Textbook**: Introduction to Psychology
**Chapter**: 3 - Memory and Learning
**Pages**: 45-52
**Created**: October 10, 2025

---

[Note content here]

---
*Generated by AI Textbook Reader*
```

**PDF Format**: Styled document with header, footer, page numbers

**Why**:
- Markdown: Developer-friendly, portable, future-proof
- PDF: Universal, printable, shareable
- Plain text: Simplest, works everywhere

---

### 4. Search Scope - Include Notes?

**DECISION: YES - Unified search across textbook AND notes**

**Implementation**:
```typescript
interface SearchResult {
  type: 'textbook' | 'note'
  textbookId: string
  chapterId?: string
  pageNumber?: number // for textbook results
  noteId?: string // for note results
  snippet: string
  relevance: number
}

// Search bar behavior:
- Type query
- See results categorized: "In Textbook" | "In Your Notes"
- Click textbook result ‚Üí Navigate to page with highlight
- Click note result ‚Üí Open note in editor
```

**SQL Query**:
```sql
-- Combined search
(
  SELECT 'textbook' as type, page_number, 
         ts_headline(text_content, query) as snippet
  FROM textbook_content
  WHERE to_tsvector(text_content) @@ query
)
UNION
(
  SELECT 'note' as type, id as note_id,
         ts_headline(content, query) as snippet
  FROM notes
  WHERE to_tsvector(content) @@ query
)
ORDER BY relevance DESC
LIMIT 20
```

**Why**: Notes often contain personal interpretations and keywords users will remember. Searching both increases utility.

---

### 5. Recall Difficulty - User Rating?

**DECISION: YES - User can rate difficulty for adaptive learning (Phase 2 feature)**

**V1 (Current Sprint)**:
- AI assigns difficulty
- User sees difficulty badge
- No rating yet

**V2 (Future)**:
```typescript
interface RecallQuestion {
  // ... existing fields
  aiDifficulty: 'easy' | 'medium' | 'hard'
  userDifficulty?: 'easy' | 'medium' | 'hard' // user can override
  timesAttempted: number
  timesCorrect: number // self-reported
  lastAttempted?: Date
  nextReview?: Date // spaced repetition
}

// UI: After revealing answer
"Was this question:"
[Too Easy] [Just Right] [Too Hard]
"Did you get it right?"
[Yes] [No]
```

**Why**: Foundation for spaced repetition system. Low effort to implement now, high value later.

---

### 6. Chat History - Forever or Limit?

**DECISION: Keep last 50 messages per textbook, with option to clear**

**Implementation**:
```typescript
// Database: No limit
// Frontend: Load last 50 on open, infinite scroll for older

interface ChatSettings {
  maxMessagesLoaded: 50
  autoDeleteAfterDays?: null // keep forever by default
  enableClearHistory: true
}

// UI: 
- Chat panel header: "Clear History" button
- Settings: "Delete chat history older than X days" (off by default)
```

**Why**: 
- Context is valuable (referring back to previous questions)
- Storage is cheap
- Users should control their data
- 50 messages = ~2 weeks of active use

**Cost consideration**: 50 messages √ó 500 tokens avg = 25k tokens = $0.02 storage

---

### 7. Mobile Priority - Desktop First or Mobile First?

**DECISION: Desktop First, Tablet Optimized, Mobile Supported (read-only)**

**Reasoning**:
| Device | Use Case | Priority | Features |
|--------|----------|----------|----------|
| Desktop | Primary study environment | **P0** | Full functionality |
| Tablet (iPad) | Reading on couch/bed | **P1** | Full read, limited edit |
| Mobile (Phone) | Quick reference | **P2** | Read textbook, view notes (no edit) |

**Mobile Strategy**:
```typescript
// Responsive breakpoints:
- Desktop: > 1024px (3-panel layout)
- Tablet: 768-1024px (2-panel layout, collapsible sidebar)
- Mobile: < 768px (single panel, tabs for switching)

// Mobile limitations (v1):
- Cannot upload textbooks (use desktop)
- Cannot edit notes (view only)
- Cannot create AI content (view cached)
- Chat works (simplified UI)
```

**Why**: 
- Users study seriously on desktops
- PDF reading + note-taking requires screen real estate
- Mobile can come in v1.1 with dedicated effort

---

## üé® UI/UX LOCKED DECISIONS

### Color Scheme:
```css
:root {
  /* Primary - Education/Trust */
  --primary: #3b82f6; /* Blue 500 */
  --primary-dark: #2563eb; /* Blue 600 */
  
  /* Secondary - Accent */
  --secondary: #8b5cf6; /* Purple 500 */
  
  /* AI Features - Magic */
  --ai-accent: #a78bfa; /* Purple 400 */
  
  /* Backgrounds */
  --bg-primary: #ffffff;
  --bg-secondary: #f9fafb; /* Gray 50 */
  --bg-tertiary: #f3f4f6; /* Gray 100 */
  
  /* Text */
  --text-primary: #111827; /* Gray 900 */
  --text-secondary: #6b7280; /* Gray 500 */
  
  /* Borders */
  --border: #e5e7eb; /* Gray 200 */
  
  /* Status */
  --success: #10b981; /* Green 500 */
  --error: #ef4444; /* Red 500 */
  --warning: #f59e0b; /* Amber 500 */
}
```

### Typography:
```css
/* Headings */
--font-heading: 'Inter', system-ui, sans-serif;
--font-body: 'Inter', system-ui, sans-serif;
--font-mono: 'JetBrains Mono', monospace;

/* Sizes */
--text-xs: 0.75rem;
--text-sm: 0.875rem;
--text-base: 1rem;
--text-lg: 1.125rem;
--text-xl: 1.25rem;
--text-2xl: 1.5rem;
--text-3xl: 1.875rem;
```

### Spacing System:
```css
--spacing-1: 0.25rem;
--spacing-2: 0.5rem;
--spacing-3: 0.75rem;
--spacing-4: 1rem;
--spacing-6: 1.5rem;
--spacing-8: 2rem;
```

---

## üîß TECHNICAL LOCKED DECISIONS

### 1. State Management

**DECISION: React Context + Zustand hybrid**

```typescript
// Context for:
- Auth (AuthContext)
- Current Textbook (TextbookContext)
- Notes (NotesContext)

// Zustand for:
- PDF viewing state (zoom, page, scroll position)
- UI state (panel widths, collapsed states)
- Search state (results, query)

// Why: Context for shared data, Zustand for transient UI state
```

### 2. Caching Strategy

**DECISION: React Query with Supabase Realtime**

```typescript
// Cache times:
- Textbook metadata: 5 minutes
- Textbook content: 1 hour (large, rarely changes)
- Notes: Realtime (Supabase subscription)
- AI content (summaries/questions): Infinity (cached until regenerate)
- Chat messages: Realtime

// Implementation:
const { data: summaries } = useQuery({
  queryKey: ['summaries', textbookId],
  queryFn: () => getSummaries(textbookId),
  staleTime: Infinity, // cached forever
  cacheTime: 1000 * 60 * 60 * 24 // 24 hours
})
```

### 3. Error Handling Strategy

**DECISION: 4-tier error handling**

```typescript
// Tier 1: Silent retry (network blips)
// Tier 2: Toast notification (temporary errors)
// Tier 3: Error boundary (component crashes)
// Tier 4: Global error page (app-level failures)

// Example:
try {
  await saveNote(note)
} catch (error) {
  if (error.code === 'NETWORK_ERROR') {
    // Tier 1: Retry 3 times
    await retry(() => saveNote(note), 3)
  } else if (error.code === 'CONFLICT') {
    // Tier 2: Show toast
    toast.error('Note was updated elsewhere. Refreshing...')
    await refreshNote()
  } else {
    // Tier 3: Throw to error boundary
    throw error
  }
}
```

### 4. PDF Rendering Optimization

**DECISION: Virtual scrolling + Web Worker**

```typescript
// Render strategy:
1. Calculate visible pages based on scroll position
2. Render visible pages + 2 buffer pages above/below
3. Unload pages outside buffer zone
4. Use Web Worker for PDF parsing (non-blocking)

// Example:
const visiblePages = useMemo(() => {
  const startPage = Math.floor(scrollTop / avgPageHeight)
  const endPage = Math.ceil((scrollTop + viewportHeight) / avgPageHeight)
  
  return Array.from(
    { length: endPage - startPage + 5 },
    (_, i) => startPage - 2 + i
  ).filter(p => p >= 1 && p <= numPages)
}, [scrollTop, viewportHeight, numPages])
```

### 5. AI Cost Optimization

**DECISION: 5 strategies to minimize OpenAI costs**

```typescript
// 1. Cache aggressively
// 2. Use GPT-4-turbo (cheaper than GPT-4)
// 3. Batch processing
// 4. Reduce context size
// 5. Rate limiting

// Implementation:
const AI_CONFIG = {
  model: 'gpt-4-turbo',
  maxTokens: {
    summary: 300,
    recall: 500,
    chat: 2048,
    explain: 150
  },
  temperature: {
    summary: 0.3, // deterministic
    recall: 0.5, // varied
    chat: 0.7, // creative
    explain: 0.3 // deterministic
  },
  caching: {
    summaries: 'permanent',
    recalls: 'permanent',
    chat: '50-messages',
    explain: 'none' // always fresh
  },
  rateLimits: {
    summary: '5-per-hour',
    recall: '10-per-hour',
    chat: '50-per-hour',
    explain: '20-per-hour'
  }
}
```

---

## üìä PERFORMANCE TARGETS (LOCKED)

### Load Times:
```
App First Load: < 2 seconds
PDF Load: < 3 seconds (50MB file)
Page Render: < 100ms
Page Navigation: < 50ms
Search Results: < 300ms
Auto-save: < 200ms (debounced)
```

### AI Response Times:
```
Summary Generation: < 15 seconds
Recall Generation: < 20 seconds
Chat Response: < 5 seconds (streaming)
Explain Tooltip: < 3 seconds
```

### Bundle Size Targets:
```
Total JS: < 500KB gzipped
Initial Load: < 200KB gzipped
CSS: < 50KB gzipped
Fonts: < 100KB
```

### Lighthouse Scores:
```
Performance: > 90
Accessibility: > 95
Best Practices: > 95
SEO: > 90
```

---

## üéØ FEATURE PRIORITY MATRIX

### Must Have (v1.0) - Current Sprints:
‚úÖ Authentication
‚úÖ PDF Upload
‚úÖ PDF Viewing with text selection
‚úÖ Notes (create, edit, auto-save, export)
‚úÖ Multiple textbook management
‚úÖ Search (textbook + notes)
‚úÖ Auto-explain tooltip
‚úÖ Chapter summaries
‚úÖ Recall questions
‚úÖ Context-aware chat

### Should Have (v1.1) - Post-Launch:
üîÑ Mobile app (React Native)
üîÑ Highlighting in PDF
üîÑ Dark mode
üîÑ Keyboard shortcuts
üîÑ Offline mode
üîÑ Advanced search (filters, operators)

### Could Have (v2.0) - Future:
‚è≥ Spaced repetition system
‚è≥ Flashcard generation
‚è≥ OCR for scanned PDFs
‚è≥ Multi-language support
‚è≥ Collaboration features
‚è≥ Lecture notes integration
‚è≥ Video lecture sync

### Won't Have (Out of Scope):
‚ùå Social features (sharing, comments)
‚ùå Marketplace (buying/selling textbooks)
‚ùå Live tutoring
‚ùå Assignment submission
‚ùå Grade tracking
‚ùå Calendar integration

---

## üîê SECURITY & PRIVACY (LOCKED)

### Data Protection:
```
1. Encryption at rest: Supabase default (AES-256)
2. Encryption in transit: TLS 1.3
3. API keys: Environment variables only
4. User data isolation: RLS policies
5. No third-party analytics: PostHog (self-hosted)
6. No ads, no tracking
```

### Privacy Policy (Summary):
```
- We store: PDFs, notes, chat messages, AI-generated content
- We don't share: Anything with anyone
- We use AI: OpenAI (GPT-4-turbo) - content not used for training
- You own: All your data
- You can: Export or delete anytime
- We keep: Data until you delete it
```

### Compliance:
```
- GDPR: Right to access, export, delete
- CCPA: Same as GDPR
- FERPA: No student records shared
- COPPA: Age gate (13+)
```

---

## üí∞ PRICING MODEL (FUTURE)

### V1.0: Free for all users
- No credit card required
- Full feature access
- Rate limits: Generous (50 AI requests/hour)

### V2.0: Freemium
```
Free Tier:
- 3 textbooks max
- 100 notes max
- 20 AI requests/day
- 1GB storage

Pro Tier ($9.99/month):
- Unlimited textbooks
- Unlimited notes
- Unlimited AI requests
- 10GB storage
- Priority support
- Early access to new features

Student Tier ($4.99/month):
- Same as Pro
- Requires .edu email
- Annual discount: $49.99/year
```

---

## üìà SUCCESS METRICS (LOCKED)

### Launch Targets (First 30 Days):
```
- 100 sign-ups
- 50 textbooks uploaded
- 500 notes created
- 1000 AI interactions
- < 5% error rate
- < 2% churn rate
```

### Engagement Metrics:
```
- DAU/MAU ratio: > 40%
- Avg session time: > 30 minutes
- Notes per textbook: > 5
- Chat messages per session: > 3
- Recall questions attempted: > 10/week
```

### Quality Metrics:
```
- User satisfaction: > 4.5/5
- AI accuracy: > 85% (user feedback)
- Bug reports: < 5/week
- Support tickets: < 10/week
```

---

## üöÄ LAUNCH PLAN (LOCKED)

### Pre-Launch (Week 0):
- [ ] Deploy to staging
- [ ] Internal testing (5 people, 3 days)
- [ ] Beta testing (20 students, 1 week)
- [ ] Fix critical bugs
- [ ] Set up monitoring (Sentry, PostHog)
- [ ] Prepare support docs

### Launch Day:
- [ ] Deploy to production
- [ ] Announce on social media
- [ ] Monitor error rates
- [ ] Monitor API costs
- [ ] Be ready for hotfixes

### Post-Launch (Week 1):
- [ ] Gather user feedback
- [ ] Fix bugs
- [ ] Monitor performance
- [ ] Optimize costs
- [ ] Plan v1.1 features

---

## ‚úÖ FINAL CHECKLIST

### Code Quality:
- [ ] TypeScript strict mode enabled
- [ ] ESLint configured and passing
- [ ] Prettier configured
- [ ] No console.log in production
- [ ] All components documented
- [ ] Test coverage > 70%

### Performance:
- [ ] Bundle size < 500KB gzipped
- [ ] Lighthouse score > 90
- [ ] PDF loads < 3s
- [ ] No memory leaks
- [ ] Optimized images

### Security:
- [ ] RLS policies tested
- [ ] API keys in env vars
- [ ] HTTPS enforced
- [ ] CORS configured
- [ ] Rate limiting enabled

### User Experience:
- [ ] Loading states everywhere
- [ ] Error messages helpful
- [ ] Empty states designed
- [ ] Keyboard navigation works
- [ ] Responsive on all devices

### Business:
- [ ] Terms of Service written
- [ ] Privacy Policy published
- [ ] Support email set up
- [ ] Analytics configured
- [ ] Cost monitoring active

---

## üéâ CONCLUSION

**ALL DECISIONS ARE NOW LOCKED.**

This document, combined with:
1. FINAL_PRODUCT_SPEC.md
2. TECHNICAL_ARCHITECTURE.md
3. SPRINT_EXECUTION_GUIDE.md

...provides a **complete, unambiguous specification** for building the AI Textbook Reader.

No more questions. No more doubts. 

**Time to build. üöÄ**

---

Version: 1.0 - FINAL AND LOCKED
Last Updated: October 10, 2025
Author: Product Team
Status: **APPROVED FOR IMPLEMENTATION**



